service: wallcity
plugins:
  - serverless-finch
  - serverless-cloudfront-invalidate
  - serverless-python-requirements
frameworkVersion: ">=2.24.0"

provider:
  name: aws
  profile: wallcity
  region: us-east-1
  runtime: python3.10
  timeout: 90
  environment:
    API_TOKEN: ${env:API_TOKEN} 
    BUCKET_NAME: ${self:custom.s3Bucket} 
  iam:
    role:
      statements:
        # Allow cloudfront invalidation
        - Effect: Allow
          Action: 'cloudfront:CreateInvalidation'
          Resource: '*'
        # Allow functions to list all buckets
        - Effect: Allow
          Action: 's3:ListBucket'
          Resource: '*'
        # Allow functions to read/write objects in a bucket
        - Effect: Allow
          Action:
            - 's3:GetObject'
            - 's3:PutObject'
          Resource:
            - 'arn:aws:s3:::${self:custom.s3Bucket}/*'
	
package:
  patterns:
    - '!src/**'
    - '!node_modules/**'
    - '!serverless.yml'
functions:
  workoutsHandler:
    handler: handler.run
    events:
      # Invoke Lambda function every day
      - schedule: cron(15 2 * * ? *) 


custom:
  cloudfrontInvalidate:
    - distributionId: E24W1LKTABLEFV
      autoInvalidate: false
      items:
        - "/*"
  s3Bucket: wallcity
  client:
    bucketName: ${self:custom.s3Bucket}
    distributionFolder: src
    #keyPrefix: static
    
resources: # CloudFormation template syntax from here on.
  Resources:
    WebAppCloudFrontDistribution:
      Type: AWS::CloudFront::Distribution
      Properties:
        DistributionConfig:
          Origins:
            - DomainName: ${self:custom.s3Bucket}.s3.amazonaws.com
              ## An identifier for the origin which must be unique within the distribution
              Id: WebApp 
              CustomOriginConfig:
                HTTPPort: 80
                HTTPSPort: 443
                OriginProtocolPolicy: https-only
              ## In case you want to restrict the bucket access use S3OriginConfig and remove CustomOriginConfig
              # S3OriginConfig:
              #   OriginAccessIdentity: origin-access-identity/cloudfront/E127EXAMPLE51Z
          Enabled: 'true'
          ## Uncomment the following section in case you are using a custom domain
          Aliases:
          - wallcity.de 
          DefaultRootObject: index.html
          PriceClass: PriceClass_100
          DefaultCacheBehavior:
            AllowedMethods:
              - DELETE
              - GET
              - HEAD
              - OPTIONS
              - PATCH
              - POST
              - PUT
            ## The origin id defined above
            TargetOriginId: WebApp
            ## Defining if and how the QueryString and Cookies are forwarded to the origin which in this case is S3
            ForwardedValues:
              QueryString: 'false'
              Cookies:
                Forward: none
            ## The protocol that users can use to access the files in the origin. To allow HTTP use `allow-all`
            ViewerProtocolPolicy: redirect-to-https
          ## The certificate to use when viewers use HTTPS to request objects.
          ViewerCertificate:
            AcmCertificateArn: arn:aws:acm:us-east-1:751535399218:certificate/7a1d881d-cbe6-411f-8e11-45cc26a3b656
            SslSupportMethod: sni-only
            MinimumProtocolVersion: TLSv1
