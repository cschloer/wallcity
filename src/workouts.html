<html>
  <head>
    <title>Wall City Workouts</title>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" href="static/assets/WallCity_favicon3.png" />

    <link href="static/external/bulma/bulma.css" rel="stylesheet" />
    <script src="https://kit.fontawesome.com/779125478c.js" crossorigin="anonymous"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.5.1/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/date-fns/1.30.1/date_fns.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-cloud/1.2.7/d3.layout.cloud.min.js"></script>
    <script src="static/external/wordcloud/wordcloud2.js"></script>


    <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>


  </head>
  <body>
    <div style="margin: 0.25rem;">
      <h3 class="is-size-3 has-text-centered">Wall City Workouts 2023/2024</h3>
      <h5 class="is-size-7 has-text-grey has-text-centered" id="lastUpdated"></h3>


      <hr />
      <div class="is-flex" style="flex-wrap: wrap;">

        <!-- MONTHLY STANDINGS -->
        <div class="box" style="flex: 6; margin: 1rem">
          <div class="has-text-centered">
            <h4 class="is-size-4 has-text-centered monthly-standings-header">Monthly Standings</h4>
            <div id="monthlyWinners"></div>
            <button class="button modal-open" target="monthlyStandingsModal">Show Full Standings</button>
            <button class="button modal-open" target="monthlyWinnersModal">Show Previous Winners</button>
          </div>
        </div>
        <div class="modal" id="monthlyWinnersModal">
          <div class="modal-background"></div>
          <div class="modal-content">
            <div class="has-background-white" style="padding: 1rem;">
              <div class="has-text-centered">
                <h4 class="is-size-4">Previous Monthly Winners</h4> 
                <div id="monthlyWinnersModalContent"></div>
              </div>
            </div>
          </div>
          <button class="modal-close is-large" aria-label="close"></button>
        </div>
        <div class="modal" id="monthlyStandingsModal">
          <div class="modal-background"></div>
          <div class="modal-content">
            <div class="has-background-white" style="padding: 1rem;">
              <div class="has-text-centered">
                <h4 class="is-size-4 monthly-standings-header">Monthly Standings</h4> 
                <div id="monthlyStandingsModalContent"></div>
              </div>
            </div>
          </div>
          <button class="modal-close is-large" aria-label="close"></button>
        </div>

        <!-- LINE GRAPH WORKOUT POSTS -->
        <div class="box" style="flex: 6; margin: 1rem">
          <h4 class="is-size-4 has-text-centered">All Workout Posts</h4>
          <canvas id="userPosts"></canvas>
        </div>

      </div>
      <div class="is-flex" style="flex-wrap: wrap;">

        <!-- OVERALL RANKINGS -->
        <div class="box" style="flex: 4; margin-left: 1rem; margin-right: 1rem;">
          <div class="has-text-centered">
             <h4 class="is-size-4">Top Posters</h4> 
             <div id="topUsers"></div>
             <button class="button modal-open" target="topUsersModal">Show All</button>
          </div>
        </div>
        <div class="modal" id="topUsersModal">
          <div class="modal-background"></div>
          <div class="modal-content">
            <div class="has-background-white" style="padding: 1rem;">
              <div class="has-text-centered">
                <h4 class="is-size-4">Top Posters</h4> 
                <div id="topUsersModalContent"></div>
              </div>
            </div>
          </div>
          <button class="modal-close is-large" aria-label="close"></button>
        </div>

        <!-- STATISTICS -->
        <div class="box has-text-centered" style="flex: 4; margin-left: 1rem; margin-right: 1rem;">
          <h4 class="is-size-4">Statistics</h4> 
          <div id="generalStatistics"></div>
        </div>

        <!-- BAR GRAPH DAY OF WEEK -->
        <div class="box" style="flex: 4; margin-left: 1rem; margin-right: 1rem; margin-bottom:  1.5rem;">
          <h4 class="is-size-4 has-text-centered">Workouts By Day of Week</h4>
          <canvas id="dayOfWeek"></canvas>
        </div>
      </div>

      <!-- WORLD CLOUD -->
      <div class="box" style="flex: 12; margin: 1rem">
        <canvas width="2048" height="1536" style="width: 100%; height: auto;" id="wordCloud"></canvas>
      </div>

      <!-- EMOJI CLOUD -->
      <div class="box" style="flex: 12; margin: 1rem">
        <canvas width="2048" height="1536" style="width: 100%; height: auto;" id="emojiCloud"></canvas>
      </div>
    </div>


    <script>

      fetch("static/assets/workouts.json")
      .then(response => response.json())
      .then(workouts => {
        // Last updated
        const since  = new Date(workouts.since)
        const updated  = new Date(workouts.updated)
        const diff = Math.floor((updated.getTime() - since.getTime() ) / ( 1000 * 60 * 60 * 24))
        const lastUpdated = document.getElementById('lastUpdated');
              lastUpdated.innerHTML = `Using data from the last ${diff} days (starting ${since.toDateString()}, updated through ${updated.toDateString()})`;

        const monthlyWinnerRowItems = workouts.user_posts_monthly.reverse().map((u, i) => {
           return `
             <tr>
               <td>${u["month"]}</td>
               <td>${u.users.join(", ")}</td>
               <td>${u.count}</td>
             </tr>
           `
          }
        )
        const monthlyStandings = workouts.user_posts_monthly_standings["users"].map((u, i) => {
           return `
             <tr>
               <td>${u.users.join(", ")}</td>
               <td>${u.count}</td>
             </tr>
           `
          }
        )
        $(".monthly-standings-header").html(`${workouts.user_posts_monthly_standings["month"]} Standings`);
          // Monthly Standings 
          const monthlyWinners = document.getElementById('monthlyWinners');
          monthlyWinners.innerHTML = `
    <table class="table is-fullwidth is-size-5">
      <thead>
        <tr>
          <th>Name(s)</th>
          <th># Workouts</th>
        </tr>
      </thead>
      <tbody>
       ${monthlyStandings.filter((_, i) => i < 5).join(" ")}
       </tbody>

    </table>
        `
        // All Monthly Standings
        const monthlyStandingsModal = $('#monthlyStandingsModalContent');
        monthlyStandingsModal[0].innerHTML = `
          <table class="table is-fullwidth is-size-5">
            <thead>
              <tr>
                <th>Name(s)</th>
                <th># Workouts</th>
              </tr>
            </thead>
            <tbody>
               ${monthlyStandings.join(" ")}
             </tbody>
          </table>
        `

        // All Monthly Winners
        const monthlyWinnersModal = $('#monthlyWinnersModalContent');
        monthlyWinnersModal[0].innerHTML = `
          <table class="table is-fullwidth is-size-5">
            <thead>
              <tr>
                <th>Month of</th>
                <th>Name(s)</th>
                <th># Workouts</th>
              </tr>
            </thead>
            <tbody>
               ${monthlyWinnerRowItems.join(" ")}
             </tbody>
          </table>
        `


        // General statistics 
        const generalStatistics = document.getElementById('generalStatistics');
        generalStatistics.innerHTML = `
     <div class="has-text-centered">
       <table class="table is-fullwidth is-size-5">
         <thead>
           <tr>
            <th></th>
            <th></th>
           </tr>
         </thead>
         <tbody>
           <tr>
             <th>Total Posts:</th>
             <td>${workouts.general_statistics.total_posts}</td>
           </tr>
           <tr>
             <th>Average Posts Per Day:</th>
             <td>${Math.round((workouts.general_statistics.total_posts / diff) * 100) / 100}</td>
           </tr>
           <tr>
             <th>Longest Daily Streak:</th>
               <td>
                  &#11088;
                  ${workouts.general_statistics.longest_streak[0].join(', ')}
                  (${workouts.general_statistics.longest_streak[1]})
               </td>
           </tr>
           <tr>
             <th>Total Emojis:</th>
             <td>${workouts.general_statistics.total_emojis}</td>
           </tr>
           <tr>
             <th>Top Emoji:</th>
             <td style="display: flex; align-items: center;">
                ${workouts.general_statistics.top_emoji.is_url ?
                  `<img src="${workouts.general_statistics.top_emoji.emoji}">` :
                  workouts.general_statistics.top_emoji.emoji
                }
                &nbsp
               (${workouts.general_statistics.top_emoji.count})
             </td>
           </tr>
         </tbody>
       </table>
     </div>
        `

      const rowItems = workouts.top_users.map((u, i) => `
       <tr>
         <th>${i + 1}</th>
         <td>${i === 0 ? '<i class="fas fa-crown mr-2" style="color: #ecbc36;"></i>' : ""}${u.name}</td>
         <td>${u.num_posts}</td>
       </tr>
     `)
        // Top users
        const topUsers = document.getElementById('topUsers');
        topUsers.innerHTML = `
          <table class="table is-fullwidth is-size-5">
            <thead>
              <tr>
                <th><abbr title="Position">Pos</abbr></th>
                <th>Name</th>
                <th># Workouts</th>
              </tr>
            </thead>
            <tbody>
             ${rowItems.filter((_, i) => i < 5).join(" ")}
             </tbody>

          </table>
        `
        // All Top Users
        const allUsersModal = $('#topUsersModalContent');
        allUsersModal[0].innerHTML = `
          <table class="table is-fullwidth is-size-5">
            <thead>
              <tr>
                <th><abbr title="Position">Pos</abbr></th>
                <th>Name</th>
                <th># Workouts</th>
              </tr>
            </thead>
            <tbody>
               ${rowItems.join(" ")}
             </tbody>
          </table>
        `

      // User Posts
      const userPosts = document.getElementById('userPosts');

      new Chart(
        userPosts,
        {
          type: 'line',
          data: {
            datasets: [
              {
                data: workouts.week_dates.map(d => {
                  return { x: d[0], y: d[1] / 7 };
                }),
                borderColor: 'rgb(75, 192, 192, 1.0)',
                backgroundColor: 'rgb(75, 192, 192, 1.0)',
                tension: 0.1,
                label: "Daily Average (Week)",
              },
              {
                data: workouts.dates.map(d => {
                  return { x: d[0], y: d[1] };
                }),
                borderColor: 'rgba(236, 188, 54, 0.3)',
                backgroundColor: 'rgba(236, 188, 54, 0.3)',
                tension: 0.1,
                label: "Daily Sum",
              },
            ],
          },
          options: {
              scales: {
                  x: {
                      type: 'time',
                      time: {
                        unit: 'week',
                        displayFormats: {
                          quarter: 'MMM YYYY'
                        },
                        tooltipFormat: "MMM dd, yyyy"
                      },
                  }
              }
          }
        });

      // Day of Week
      const dayOfWeek = document.getElementById('dayOfWeek');


      new Chart(
        dayOfWeek,
        {
          type: 'bar',
          data: {
            labels: workouts.day_of_week.map(d => d[0]),
            datasets: [{
              backgroundColor: 'rgba(236, 188, 54, 0.8)',
              data: workouts.day_of_week.map(d => d[1]),
            }],
          },
          options: {
              plugins: {
                legend: {
                  display: false,

                }
              },
          }
        });

        // Word Cloud
        new Promise(async () => {
          await new Promise(resolve => setTimeout(resolve, 1000))
          WordCloud(
              document.getElementById('wordCloud'),
              {
                list: workouts.words.map((w) => [ w[0], w[1] ] ).filter(w => w[1] > 3),
                gridSize: 16,
                weightFactor: 3,
              },
          );
        })
        // Emoji Cloud
        new Promise(async () => {
          await new Promise(resolve => setTimeout(resolve, 1000))
          WordCloud(
              document.getElementById('emojiCloud'),
              {
                list: workouts.emojis.map((e) => [e.emoji, e.count] ).filter(w => !w[0].startsWith("https://") && w[1] > 5),
                gridSize: 16,
                weightFactor: 2,
              },
          );
        })


        // Handle modals
        $('.modal-open').on("click", function() {
          $(`#${$(this).attr("target")}`).addClass("is-active")
        });
        $('.modal-close, .modal-background').on("click", function() {
          $(this).closest(".modal").removeClass("is-active")
        });

      });
    </script>

  </body>


</html>
